<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chicago Bulls Cap Manager</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

* { margin:0; padding:0; box-sizing:border-box; }

:root {
  --red:#CE1141; --red-dark:#a00d33;
  --bg0:#0a0a0a; --bg1:#1a1a1a; --bg2:#2a2a2a; --bg3:#333;
  --txt:#fff; --txt2:#a0a0a0;
  --green:#10b981; --amber:#f59e0b; --danger:#ef4444;
  --pink:#ec4899; --blue:#3b82f6; --gray:#6b7280; --purple:#a855f7;
}

body {
  font-family:'Inter',sans-serif;
  background:linear-gradient(135deg,var(--bg0) 0%,#1a0a0f 100%);
  color:var(--txt); min-height:100vh; padding:20px;
}
.container { max-width:1900px; margin:0 auto; }

/* â”€â”€â”€ HEADER â”€â”€â”€ */
.header {
  background:linear-gradient(135deg,var(--red),var(--red-dark));
  padding:28px 32px; border-radius:14px; margin-bottom:24px;
  box-shadow:0 16px 48px rgba(206,17,65,.3);
  position:relative; overflow:hidden;
}
.header::before {
  content:''; position:absolute; inset:0;
  background:radial-gradient(circle at 80% 50%,rgba(255,255,255,.07) 0%,transparent 60%);
}
.header > * { position:relative; z-index:1; }
.header h1 { font-size:38px; font-weight:800; letter-spacing:-.02em; margin-bottom:8px; }
.header .sub { font-size:14px; opacity:.9; font-weight:400; line-height:1.5; margin-bottom:4px; }
.header .sub a { color:#fff; text-decoration:underline; font-weight:600; }

/* â”€â”€â”€ CONTROLS â”€â”€â”€ */
.controls { display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap; align-items:center; }
.controls-row-2 { display:flex; gap:8px; margin-bottom:20px; }
.search-wrap { position:relative; flex:1; max-width:320px; }
.search-input {
  width:100%; background:var(--bg1); border:1px solid var(--bg3); color:var(--txt);
  padding:11px 14px; border-radius:8px; font-size:14px; font-family:inherit;
}
.search-input:focus { outline:none; border-color:var(--red); }

.dropdown {
  position:absolute; top:calc(100% + 4px); left:0; right:0;
  background:var(--bg1); border:1px solid var(--bg3); border-radius:8px;
  max-height:260px; overflow-y:auto; z-index:200; display:none;
}
.dropdown.show { display:block; }
.dropdown-item { padding:11px 14px; cursor:pointer; border-bottom:1px solid var(--bg3); transition:background .15s; }
.dropdown-item:last-child { border-bottom:none; }
.dropdown-item:hover { background:var(--bg2); }
.dropdown-item .d-name { font-weight:600; font-size:14px; }
.dropdown-item .d-meta { font-size:12px; color:var(--txt2); margin-top:2px; }

.btn {
  background:var(--bg1); border:1px solid var(--bg3); color:var(--txt);
  padding:11px 18px; border-radius:8px; font-size:13px; font-weight:600;
  cursor:pointer; transition:.2s; display:flex; align-items:center; gap:6px; white-space:nowrap;
}
.btn:hover { background:var(--bg2); transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.3); }
.btn-red { background:var(--red); border-color:var(--red); }
.btn-red:hover { background:var(--red-dark); }

/* â”€â”€â”€ SUMMARY CARDS â”€â”€â”€ */
.cards { display:grid; grid-template-columns:repeat(5,1fr); gap:14px; margin-bottom:20px; }
.card {
  background:var(--bg1); border:1px solid var(--bg3); border-radius:10px; padding:16px;
  transition:.25s;
}
.card:hover { transform:translateY(-3px); box-shadow:0 8px 24px rgba(0,0,0,.4); }
.card.c-ok   { border-color:var(--green); background:linear-gradient(135deg,var(--bg1),rgba(16,185,129,.08)); }
.card.c-warn { border-color:var(--amber); background:linear-gradient(135deg,var(--bg1),rgba(245,158,11,.08)); }
.card.c-bad  { border-color:var(--danger); background:linear-gradient(135deg,var(--bg1),rgba(239,68,68,.08)); }
.card .c-lbl { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.06em; color:var(--txt2); margin-bottom:6px; }
.card .c-val { font-size:24px; font-weight:700; }
.card .c-sub { font-size:12px; color:var(--txt2); margin-top:3px; }

/* â”€â”€â”€ LEGEND â”€â”€â”€ */
.legend {
  background:var(--bg1); border:1px solid var(--bg3); border-radius:10px;
  padding:14px 18px; margin-bottom:20px; display:flex; align-items:center; gap:20px; flex-wrap:wrap;
}
.legend .lbl { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:.06em; color:var(--txt2); }
.legend-items { display:flex; gap:14px; flex-wrap:wrap; }
.legend-item { display:flex; align-items:center; gap:6px; font-size:12px; }
.lg-badge { padding:3px 7px; border-radius:4px; font-size:10px; font-weight:700; letter-spacing:.04em; }
.lg-gtd { background:rgba(16,185,129,.15); color:var(--green); border:1px solid rgba(16,185,129,.3); }
.lg-po { background:rgba(59,130,246,.15); color:var(--blue); border:1px solid rgba(59,130,246,.3); }
.lg-to { background:rgba(236,72,153,.15); color:var(--pink); border:1px solid rgba(236,72,153,.3); }
.lg-qo { background:rgba(168,85,247,.15); color:var(--purple); border:1px solid rgba(168,85,247,.3); }
.lg-ch { background:rgba(245,158,11,.15); color:var(--amber); border:1px solid rgba(245,158,11,.3); }
.lg-dead { background:rgba(107,114,128,.15); color:var(--gray); border:1px solid rgba(107,114,128,.3); }

/* â”€â”€â”€ TABLE - PERFECTLY ALIGNED â”€â”€â”€ */
.section {
  background:var(--bg1); border:1px solid var(--bg3); border-radius:10px;
  padding:0; margin-bottom:20px; overflow:hidden;
}
.section-hdr {
  background:var(--bg2); padding:14px 20px; font-weight:700; font-size:14px;
  letter-spacing:.02em; border-bottom:1px solid var(--bg3); display:flex; align-items:center; justify-content:space-between;
}
.section-hdr-sub { font-size:12px; font-weight:600; color:var(--txt2); }

.tbl-wrap { overflow-x:auto; }

/* Perfect alignment: 60px + 240px + (5 Ã— 160px) + 320px = 1420px */
.tbl-head, .tbl-row {
  display:grid;
  grid-template-columns: 60px 240px repeat(5, 160px) 320px;
  gap:0; padding:0 20px; align-items:center;
}

.tbl-head {
  background:var(--bg2); padding:12px 20px; font-size:11px; font-weight:700;
  text-transform:uppercase; letter-spacing:.06em; color:var(--txt2);
  border-bottom:1px solid var(--bg3);
}
.h-sal { text-align:center; }

.tbl-row {
  padding:16px 20px; border-bottom:1px solid rgba(51,51,51,.5);
  transition:background .15s;
}
.tbl-row:hover { background:rgba(255,255,255,.02); }
.tbl-row:last-child { border-bottom:none; }

.r-num { color:var(--txt2); font-size:13px; font-weight:600; text-align:center; }
.r-name { font-weight:600; font-size:14px; padding-right:15px; }
.sal-cell { text-align:center; padding:0 5px; }
.s-amt { font-size:13px; font-weight:600; display:block; }
.s-pct { font-size:10px; color:var(--txt2); margin-top:2px; display:block; }
.s-badge { 
  display:inline-block; padding:2px 6px; border-radius:3px; 
  font-size:9px; font-weight:700; letter-spacing:.04em; margin-left:4px;
}
.s-gtd { background:rgba(16,185,129,.15); color:var(--green); border:1px solid rgba(16,185,129,.3); }
.s-po { background:rgba(59,130,246,.15); color:var(--blue); border:1px solid rgba(59,130,246,.3); }
.s-to { background:rgba(236,72,153,.15); color:var(--pink); border:1px solid rgba(236,72,153,.3); }
.s-qo { background:rgba(168,85,247,.15); color:var(--purple); border:1px solid rgba(168,85,247,.3); }
.s-ch { background:rgba(245,158,11,.15); color:var(--amber); border:1px solid rgba(245,158,11,.3); }

.act { display:grid; grid-template-columns:1fr 1fr; gap:8px; padding-left:20px; }
.act-btn {
  background:var(--bg2); border:1px solid var(--bg3); color:var(--txt);
  padding:8px 14px; border-radius:6px; font-size:11px; font-weight:600;
  cursor:pointer; transition:.15s; text-align:center; display:flex;
  align-items:center; justify-content:center; gap:5px;
}
.act-btn:hover { background:var(--bg3); transform:translateY(-1px); }
.act-btn.disabled { opacity:.3; cursor:not-allowed; }
.act-btn.disabled:hover { transform:none; }

/* â”€â”€â”€ FLIPPED TABLES (Years as Columns) â”€â”€â”€ */
.flip-table { width:100%; border-collapse:collapse; margin-top:12px; }
.flip-table th {
  background:var(--bg2); padding:10px; text-align:center; font-size:11px;
  font-weight:700; text-transform:uppercase; letter-spacing:.06em; color:var(--txt2);
  border-bottom:1px solid var(--bg3);
}
.flip-table th:first-child { text-align:left; }
.flip-table td {
  padding:10px; font-size:13px; border-bottom:1px solid rgba(51,51,51,.3);
  text-align:center; font-weight:600;
}
.flip-table td:first-child { text-align:left; font-weight:600; }
.flip-table tr:last-child td { border-bottom:none; }
.flip-table td.pos { color:var(--green); }
.flip-table td.neg { color:var(--danger); }

/* â”€â”€â”€ TRADE BLOCK â”€â”€â”€ */
.trade-section { background:rgba(59,130,246,.05); border:2px solid var(--blue); }
.trade-subsection { padding:16px 20px; border-bottom:1px solid rgba(59,130,246,.2); }
.trade-subsection:last-child { border-bottom:none; }
.trade-subsection-hdr {
  font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:.06em;
  color:var(--blue); margin-bottom:12px; display:flex; align-items:center; gap:8px;
}

/* Trade block with year headers */
.trade-year-headers {
  display:grid;
  grid-template-columns: 60px 240px repeat(5, 160px) 320px;
  gap:0; padding:0 20px 8px 20px;
  font-size:10px; font-weight:700; text-transform:uppercase;
  letter-spacing:.06em; color:var(--blue);
}
.trade-year-headers div { text-align:center; }
.trade-year-headers div:first-child,
.trade-year-headers div:nth-child(2) { text-align:left; padding-right:0; }
.trade-year-headers div:nth-child(2) { visibility:hidden; }

.trade-total {
  background:rgba(59,130,246,.1); padding:12px 20px; font-size:13px; font-weight:600;
  border-top:2px solid var(--blue); display:grid;
  grid-template-columns: 60px 240px repeat(5, 160px) 320px;
  gap:0; align-items:center;
}
.trade-total div { text-align:center; font-weight:700; color:var(--blue); }
.trade-total div:first-child { text-align:center; }
.trade-total div:nth-child(2) { text-align:left; padding-right:0; }

.trade-legality {
  background:rgba(245,158,11,.08); border:1px solid rgba(245,158,11,.3);
  padding:14px 18px; margin:16px 20px; border-radius:8px;
}
.trade-legality-title {
  font-size:12px; font-weight:700; color:var(--amber); margin-bottom:8px;
  display:flex; align-items:center; gap:6px;
}
.trade-legality-row {
  display:flex; justify-content:space-between; padding:6px 0;
  font-size:12px; border-bottom:1px solid rgba(245,158,11,.1);
}
.trade-legality-row:last-child { border-bottom:none; padding-top:10px; }
.trade-legality-row .lbl { color:var(--txt2); }
.trade-legality-row .val { font-weight:600; }
.trade-status { font-size:14px; font-weight:700; display:flex; align-items:center; gap:6px; }
.trade-status.legal { color:var(--green); }
.trade-status.illegal { color:var(--danger); }

/* â”€â”€â”€ MODAL â”€â”€â”€ */
.modal-overlay {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,.85);
  z-index:1000; align-items:center; justify-content:center;
}
.modal-overlay.show { display:flex; }
.modal {
  background:var(--bg1); border:1px solid var(--bg3); border-radius:12px;
  max-width:500px; width:90%; max-height:80vh; overflow:auto;
}
.modal-hdr {
  background:var(--bg2); padding:18px 24px; border-bottom:1px solid var(--bg3);
  font-size:16px; font-weight:700;
}
.modal-body { padding:24px; }
.modal-row { margin-bottom:16px; }
.modal-row:last-child { margin-bottom:0; }
.modal-lbl { font-size:12px; font-weight:600; color:var(--txt2); margin-bottom:6px; text-transform:uppercase; letter-spacing:.04em; }
.modal-input, .modal-select {
  width:100%; background:var(--bg2); border:1px solid var(--bg3); color:var(--txt);
  padding:10px 12px; border-radius:6px; font-size:14px; font-family:inherit;
}
.modal-input:focus, .modal-select:focus { outline:none; border-color:var(--red); }
.modal-input-group { display:flex; align-items:center; gap:8px; }
.modal-input-group input, .modal-input-group select { flex:1; }
.modal-input-group span { font-size:14px; font-weight:600; color:var(--txt2); }
.modal-actions { display:flex; gap:10px; margin-top:24px; justify-content:flex-end; }
.modal-btn {
  padding:10px 20px; border-radius:6px; font-size:13px; font-weight:600;
  cursor:pointer; transition:.2s; border:none;
}
.modal-btn-cancel { background:var(--bg2); color:var(--txt); }
.modal-btn-cancel:hover { background:var(--bg3); }
.modal-btn-primary { background:var(--red); color:#fff; }
.modal-btn-primary:hover { background:var(--red-dark); }
.modal-btn-danger { background:var(--danger); color:#fff; }
.modal-btn-danger:hover { background:#dc2626; }

</style>
</head>
<body>
<div class="container">

<div class="header">
  <h1>ğŸ€ Chicago Bulls Cap Manager</h1>
  <div class="sub">You be the GM: Make trades, sign free agents and manage the Bulls multi-year cap sheet.</div>
  <div class="sub">Created by <a href="https://x.com/Will_Gottlieb" target="_blank">Will Gottlieb</a></div>
</div>

<div class="controls">
  <div class="search-wrap">
    <input type="text" class="search-input" id="searchInput" placeholder="Search NBA players..." autocomplete="off">
    <div class="dropdown" id="searchDropdown"></div>
  </div>
  <button class="btn" onclick="addRow()">â• Add Row</button>
  <button class="btn" onclick="undo()">â—€ Undo</button>
  <button class="btn" onclick="redo()">â–¶ Redo</button>
  <button class="btn" onclick="resetAll()">ğŸ”„ Reset</button>
</div>

<div class="controls-row-2">
  <button class="btn btn-red" id="tradeModeBtn" onclick="setAcquisitionMode('trade')">ğŸ”„ Trade Mode</button>
  <button class="btn" id="faModeBtn" onclick="setAcquisitionMode('fa')">âœï¸ FA Mode</button>
</div>

<!-- TEAM SALARY CARDS (Above legend) -->
<div class="cards" id="cards"></div>

<div class="legend">
  <span class="lbl">LEGEND:</span>
  <div class="legend-items">
    <div class="legend-item"><span class="lg-badge lg-gtd">GTD</span> Guaranteed</div>
    <div class="legend-item"><span class="lg-badge lg-po">PO</span> Player Option</div>
    <div class="legend-item"><span class="lg-badge lg-to">TO</span> Team Option</div>
    <div class="legend-item"><span class="lg-badge lg-qo">QO</span> Qualifying Offer</div>
    <div class="legend-item"><span class="lg-badge lg-ch">CH</span> Cap Hold</div>
    <div class="legend-item"><span class="lg-badge lg-dead">DEAD</span> Dead Money</div>
  </div>
</div>

<!-- TRADE BLOCK -->
<div class="section trade-section" id="tradeSection" style="display:none">
  <div class="section-hdr">
    ğŸ”„ Trade Block
    <span class="section-hdr-sub" id="tradeModeIndicator"></span>
  </div>
  
  <div class="trade-subsection" id="incomingSection" style="display:none">
    <div class="trade-subsection-hdr">ğŸ“¥ INCOMING PLAYERS</div>
    <div class="trade-year-headers">
      <div></div><div></div>
      <div>2025-26</div><div>2026-27</div><div>2027-28</div><div>2028-29</div><div>2029-30</div>
      <div></div>
    </div>
    <div id="incomingBody"></div>
    <div class="trade-total" id="incomingTotal"></div>
  </div>
  
  <div class="trade-subsection">
    <div class="trade-subsection-hdr">ğŸ“¤ OUTGOING PLAYERS</div>
    <div class="trade-year-headers">
      <div></div><div></div>
      <div>2025-26</div><div>2026-27</div><div>2027-28</div><div>2028-29</div><div>2029-30</div>
      <div></div>
    </div>
    <div id="tradeBody"></div>
    <div class="trade-total" id="outgoingTotal"></div>
  </div>
  
  <div id="tradeLegalityBox"></div>
</div>

<!-- ACTIVE ROSTER -->
<div class="section" id="activeSection">
  <div class="section-hdr">
    Active Roster (2025-26)
    <span class="section-hdr-sub"><span id="activeCount">0</span> players Â· <span id="gtdCount">0</span> GTD</span>
  </div>
  <div class="tbl-wrap">
    <div class="tbl-head">
      <div class="h-num">#</div>
      <div class="h-name">Player</div>
      <div class="h-sal" onclick="setSortYear('2025-26')" style="cursor:pointer" title="Click to sort">
        2025-26 <span id="sort-2025-26">â–¼</span>
      </div>
      <div class="h-sal" onclick="setSortYear('2026-27')" style="cursor:pointer" title="Click to sort">
        2026-27 <span id="sort-2026-27" style="display:none">â–¼</span>
      </div>
      <div class="h-sal" onclick="setSortYear('2027-28')" style="cursor:pointer" title="Click to sort">
        2027-28 <span id="sort-2027-28" style="display:none">â–¼</span>
      </div>
      <div class="h-sal" onclick="setSortYear('2028-29')" style="cursor:pointer" title="Click to sort">
        2028-29 <span id="sort-2028-29" style="display:none">â–¼</span>
      </div>
      <div class="h-sal" onclick="setSortYear('2029-30')" style="cursor:pointer" title="Click to sort">
        2029-30 <span id="sort-2029-30" style="display:none">â–¼</span>
      </div>
      <div class="h-act">Actions</div>
    </div>
    <div id="rosterBody"></div>
  </div>
</div>

<!-- DEAD MONEY -->
<div class="section" id="deadSection" style="display:none">
  <div class="section-hdr">ğŸ’€ Dead Money</div>
  <div style="padding:20px">
    <table class="flip-table" id="deadMoneyTable"></table>
  </div>
</div>

<!-- CAP SITUATION (Flipped) -->
<div class="section">
  <div class="section-hdr">ğŸ“Š Cap Situation</div>
  <div style="padding:20px">
    <table class="flip-table">
      <thead>
        <tr>
          <th>Status</th>
          <th>2025-26</th>
          <th>2026-27</th>
          <th>2027-28</th>
          <th>2028-29</th>
          <th>2029-30</th>
        </tr>
      </thead>
      <tbody id="capSituationBody"></tbody>
    </table>
  </div>
</div>

<!-- CAP THRESHOLDS (Flipped) -->
<div class="section" style="margin-top:22px">
  <div class="section-hdr">ğŸ“‹ Cap Thresholds</div>
  <div style="padding:20px">
    <table class="flip-table">
      <thead>
        <tr>
          <th>Threshold</th>
          <th>2025-26</th>
          <th>2026-27</th>
          <th>2027-28</th>
          <th>2028-29</th>
          <th>2029-30</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Salary Cap</td>
          <td>$154.6M</td>
          <td>$165.5M</td>
          <td>$173.7M</td>
          <td>$182.4M</td>
          <td>$191.6M</td>
        </tr>
        <tr>
          <td>Luxury Tax</td>
          <td>$187.9M</td>
          <td>$201.0M</td>
          <td>$215.1M</td>
          <td>$230.2M</td>
          <td>$246.3M</td>
        </tr>
        <tr>
          <td>First Apron</td>
          <td>$195.9M</td>
          <td>$209.7M</td>
          <td>$224.3M</td>
          <td>$240.0M</td>
          <td>$256.8M</td>
        </tr>
        <tr>
          <td>Second Apron</td>
          <td>$207.8M</td>
          <td>$222.4M</td>
          <td>$237.9M</td>
          <td>$254.6M</td>
          <td>$272.4M</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modal"></div>
</div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULLS CAP MANAGER V5.1 - FINAL
// Trade Executed: Å ariÄ‡ & Huerter OUT, Ivey & Conley IN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let acquisitionMode = 'trade';
let sortYear = '2025-26';
let history = [];
let historyIndex = -1;
const MAX_HISTORY = 20;
let redoStack = [];
let tradeBlock = [];
let incomingPlayers = [];

const YEARS = ['2025-26', '2026-27', '2027-28', '2028-29', '2029-30'];

const CAP_THRESHOLDS = {
  '2025-26': { cap: 154647000, tax: 187897000, apron1: 195946000, apron2: 207825000 },
  '2026-27': { cap: 165472290, tax: 201049790, apron1: 209662220, apron2: 222372750 },
  '2027-28': { cap: 173745905, tax: 215123275, apron1: 224338575, apron2: 237938843 },
  '2028-29': { cap: 182433200, tax: 230181905, apron1: 240042276, apron2: 254594561 },
  '2029-30': { cap: 191554860, tax: 246294638, apron1: 256845235, apron2: 272416181 }
};

// ROSTER - TRADES EXECUTED: 
// Trade 1: Å ariÄ‡ & Huerter OUT, Ivey & Conley IN
// Trade 2: VuÄeviÄ‡ OUT, Simons IN
let roster = [
  { id:1, name:"Josh Giddey", sal:{'2025-26':25000000, '2026-27':25000000, '2027-28':25000000, '2028-29':25000000, '2029-30':37500000}, typ:{'2025-26':'gtd', '2026-27':'gtd', '2027-28':'gtd', '2028-29':'gtd', '2029-30':'ch'} },
  { id:18, name:"Anfernee Simons", sal:{'2025-26':27678571, '2026-27':41517857, '2027-28':0, '2028-29':0, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'ch', '2027-28':'', '2028-29':'', '2029-30':''} },
  { id:3, name:"Zach Collins", sal:{'2025-26':18080496, '2026-27':27120744, '2027-28':0, '2028-29':0, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'ch', '2027-28':'', '2028-29':'', '2029-30':''} },
  { id:4, name:"Patrick Williams", sal:{'2025-26':18000000, '2026-27':18000000, '2027-28':18000000, '2028-29':18000000, '2029-30':34200000}, typ:{'2025-26':'gtd', '2026-27':'gtd', '2027-28':'gtd', '2028-29':'po', '2029-30':'ch'} },
  { id:6, name:"Coby White", sal:{'2025-26':12888889, '2026-27':24488889, '2027-28':0, '2028-29':0, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'ch', '2027-28':'', '2028-29':'', '2029-30':''} },
  { id:7, name:"Isaac Okoro", sal:{'2025-26':11000000, '2026-27':11814814, '2027-28':22448147, '2028-29':0, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'gtd', '2027-28':'ch', '2028-29':'', '2029-30':''} },
  { id:17, name:"Mike Conley", sal:{'2025-26':10774038, '2026-27':20470672, '2027-28':0, '2028-29':0, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'ch', '2027-28':'', '2028-29':'', '2029-30':''} },
  { id:16, name:"Jaden Ivey", sal:{'2025-26':10107163, '2026-27':8774590, '2027-28':0, '2028-29':0, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'qo', '2027-28':'', '2028-29':'', '2029-30':''} },
  { id:8, name:"Jalen Smith", sal:{'2025-26':9000000, '2026-27':9428571, '2027-28':17914285, '2028-29':0, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'gtd', '2027-28':'ch', '2028-29':'', '2029-30':''} },
  { id:9, name:"Tre Jones", sal:{'2025-26':8000000, '2026-27':8000000, '2027-28':8000000, '2028-29':15200000, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'gtd', '2027-28':'gtd', '2028-29':'ch', '2029-30':''} },
  { id:10, name:"Ayo Dosunmu", sal:{'2025-26':7518518, '2026-27':14285184, '2027-28':0, '2028-29':0, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'ch', '2027-28':'', '2028-29':'', '2029-30':''} },
  { id:11, name:"Matas Buzelis", sal:{'2025-26':5455560, '2026-27':5715360, '2027-28':7584283, '2028-29':10689716, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'gtd', '2027-28':'gtd', '2028-29':'qo', '2029-30':''} },
  { id:12, name:"Noa Essengue", sal:{'2025-26':5429520, '2026-27':5701200, '2027-28':5972760, '2028-29':8230464, '2029-30':11758660}, typ:{'2025-26':'gtd', '2026-27':'gtd', '2027-28':'gtd', '2028-29':'gtd', '2029-30':'qo'} },
  { id:14, name:"Dalen Terry", sal:{'2025-26':5399118, '2026-27':7661087, '2027-28':0, '2028-29':0, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'qo', '2027-28':'', '2028-29':'', '2029-30':''} },
  { id:15, name:"Julian Phillips", sal:{'2025-26':2221677, '2026-27':2406205, '2027-28':2702711, '2028-29':0, '2029-30':0}, typ:{'2025-26':'gtd', '2026-27':'gtd', '2027-28':'ch', '2028-29':'', '2029-30':''} }
];

let deadMoney = [
  { id:100, name:"Jevon Carter", sal:{'2025-26':6809524, '2026-27':0, '2027-28':0, '2028-29':0, '2029-30':0}, typ:{'2025-26':'dead', '2026-27':'', '2027-28':'', '2028-29':'', '2029-30':''}, stretched:false, stretchStart:null }
];

let capHolds = [];
let emptyRows = [];

// Enhanced NBA_DB with new Bulls players
const NBA_DB = [
  {name:"Stephen Curry",team:"GSW",sal:{'2025-26':59606817,'2026-27':62619668,'2027-28':0,'2028-29':0,'2029-30':0}},
  {name:"Giannis Antetokounmpo",team:"MIL",sal:{'2025-26':54169127,'2026-27':58570690,'2027-28':63055395,'2028-29':0,'2029-30':0}},
  {name:"OG Anunoby",team:"NYK",sal:{'2025-26':37117812,'2026-27':40127857,'2027-28':43137903,'2028-29':46147948,'2029-30':49757143}},
  {name:"Anfernee Simons",team:"CHI",sal:{'2025-26':27678571,'2026-27':41517857,'2027-28':0,'2028-29':0,'2029-30':0}},
  {name:"Jaden Ivey",team:"CHI",sal:{'2025-26':10107163,'2026-27':8774590,'2027-28':0,'2028-29':0,'2029-30':0}},
  {name:"Mike Conley",team:"CHI",sal:{'2025-26':10774038,'2026-27':20470672,'2027-28':0,'2028-29':0,'2029-30':0}},
  {name:"Peyton Watson",team:"DEN",sal:{'2025-26':4431720,'2026-27':4431720,'2027-28':12514350,'2028-29':0,'2029-30':0}},
  {name:"Walker Kessler",team:"UTA",sal:{'2025-26':4891920,'2026-27':4891920,'2027-28':0,'2028-29':0,'2029-30':0}}
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function fmt(n) {
  if (!n || n === 0) return 'â€”';
  return '$' + (n / 1000000).toFixed(1) + 'M';
}

function pct(salary, year) {
  const cap = CAP_THRESHOLDS[year].cap;
  if (!salary || salary === 0) return '';
  return ((salary / cap) * 100).toFixed(1) + '%';
}

function sorted() {
  return [...roster].sort((a, b) => (b.sal[sortYear] || 0) - (a.sal[sortYear] || 0));
}

function setSortYear(year) {
  sortYear = year;
  render();
}

function setAcquisitionMode(mode) {
  acquisitionMode = mode;
  const tradeBtn = document.getElementById('tradeModeBtn');
  const faBtn = document.getElementById('faModeBtn');
  
  if (mode === 'trade') {
    tradeBtn.className = 'btn btn-red';
    faBtn.className = 'btn';
    document.getElementById('tradeModeIndicator').textContent = 'Trade Mode Active';
  } else {
    tradeBtn.className = 'btn';
    faBtn.className = 'btn btn-red';
    document.getElementById('tradeModeIndicator').textContent = 'Free Agency Mode Active';
  }
  
  renderTrade();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENHANCED STRETCH PROVISION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function calculateStretchProvision(player, startYear) {
  const includedTypes = ['gtd', 'po', 'to'];
  const startIdx = YEARS.indexOf(startYear);
  if (startIdx === -1) return null;
  
  let totalGtd = 0;
  let yearsToStretch = 0;
  
  for (let i = startIdx; i < YEARS.length; i++) {
    const year = YEARS[i];
    const sal = player.sal[year] || 0;
    const typ = player.typ[year] || '';
    
    if (includedTypes.includes(typ) && sal > 0) {
      totalGtd += sal;
      yearsToStretch++;
    }
  }
  
  if (yearsToStretch === 0 || totalGtd === 0) return null;
  
  const stretchYears = (yearsToStretch * 2) + 1;
  const annualHit = Math.floor(totalGtd / stretchYears);
  
  return {
    totalGtd,
    yearsToStretch,
    stretchYears,
    annualHit,
    startYear,
    startIdx
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADE LEGALITY CALCULATOR (2025-26 Only)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function calculateTradeMatch(outgoing) {
  if (outgoing < 8270000) {
    return {
      max: Math.floor(outgoing * 2 + 250000),
      formula: "200% + $250K",
      rule: "Under $8.27M"
    };
  } else if (outgoing < 33100000) {
    return {
      max: Math.floor(outgoing + 8500000),
      formula: "100% + $8.5M",
      rule: "$8.27M to $33.1M"
    };
  } else {
    return {
      max: Math.floor(outgoing * 1.25 + 250000),
      formula: "125% + $250K",
      rule: "Over $33.1M"
    };
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function render() {
  renderCards();
  renderRoster();
  renderDead();
  renderTrade();
  renderCapSituation();
  
  YEARS.forEach(y => {
    const el = document.getElementById(`sort-${y}`);
    if (el) el.style.display = (y === sortYear) ? 'inline' : 'none';
  });
}

function renderCards() {
  const cards = YEARS.map(year => {
    const total = roster.reduce((sum, p) => sum + (p.sal[year] || 0), 0) +
                  deadMoney.reduce((sum, p) => sum + (p.sal[year] || 0), 0);
    const th = CAP_THRESHOLDS[year];
    const room = th.cap - total;
    
    let cls = 'card';
    let nextThreshold = '';
    
    if (total > th.apron2) {
      cls += ' c-bad';
      const over = total - th.apron2;
      nextThreshold = `2nd Apron: ${fmt(over)} over`;
    } else if (total > th.apron1) {
      cls += ' c-bad';
      const away = th.apron2 - total;
      nextThreshold = `2nd Apron: ${fmt(away)} away`;
    } else if (total > th.tax) {
      cls += ' c-warn';
      const away = th.apron1 - total;
      nextThreshold = `1st Apron: ${fmt(away)} away`;
    } else if (total > th.cap) {
      cls += ' c-warn';
      const away = th.tax - total;
      nextThreshold = `Tax: ${fmt(away)} away`;
    } else {
      cls += ' c-ok';
      const away = th.tax - total;
      nextThreshold = `Tax: ${fmt(away)} away`;
    }
    
    return `
      <div class="${cls}">
        <div class="c-lbl">Team Salary Â· ${year}</div>
        <div class="c-val">${fmt(total)}</div>
        <div class="c-sub">${room > 0 ? fmt(room) + ' under cap' : fmt(Math.abs(room)) + ' over cap'}</div>
        <div class="c-sub" style="margin-top:4px; color:var(--txt); font-weight:600">${nextThreshold}</div>
      </div>
    `;
  }).join('');
  
  document.getElementById('cards').innerHTML = cards;
}

function renderRoster() {
  const s = sorted();
  const activeRoster = s.filter(p => !tradeBlock.some(t => t.id === p.id));
  
  document.getElementById('activeCount').textContent = activeRoster.length;
  const gtdCount = activeRoster.filter(p => p.typ['2025-26'] === 'gtd' && p.sal['2025-26']).length;
  document.getElementById('gtdCount').textContent = gtdCount;
  
  const html = activeRoster.map((p, i) => {
    const salCells = YEARS.map(year => {
      const sal = p.sal[year] || 0;
      const typ = p.typ[year] || '';
      const percentage = pct(sal, year);
      let badge = '';
      if (typ === 'gtd') badge = '<span class="s-badge s-gtd">GTD</span>';
      else if (typ === 'po') badge = '<span class="s-badge s-po">PO</span>';
      else if (typ === 'to') badge = '<span class="s-badge s-to">TO</span>';
      else if (typ === 'qo') badge = '<span class="s-badge s-qo">QO</span>';
      else if (typ === 'ch') badge = '<span class="s-badge s-ch">CH</span>';
      
      return `
        <div class="sal-cell">
          <span class="s-amt">${fmt(sal)}</span>
          <span class="s-pct">${percentage}</span>
          ${badge ? badge : ''}
        </div>
      `;
    }).join('');
    
    const hasOption = YEARS.some(y => ['po','to','qo','ch'].includes(p.typ[y]));
    const isCapHold = YEARS.slice(1).some(y => p.typ[y] === 'ch');
    
    const actions = `
      <div class="act">
        <button class="act-btn ${hasOption ? '' : 'disabled'}" onclick="handleOption(${p.id})" ${!hasOption ? 'disabled' : ''}>
          <span>âš™ï¸</span><span>Option</span>
        </button>
        <button class="act-btn ${isCapHold ? '' : 'disabled'}" onclick="waiveCapHold(${p.id})" ${!isCapHold ? 'disabled' : ''}>
          <span>ğŸ§¢</span><span>Cap Hold</span>
        </button>
        <button class="act-btn" onclick="toggleTrade(${p.id})">
          <span>ğŸ”„</span><span>Trade</span>
        </button>
        <button class="act-btn" onclick="handleWaive(${p.id})">
          <span>âœ‚ï¸</span><span>Waive</span>
        </button>
      </div>
    `;
    
    return `
      <div class="tbl-row" id="player-${p.id}">
        <div class="r-num">${i + 1}</div>
        <div class="r-name" onclick="editContract(${p.id})" style="cursor:pointer; text-decoration:underline" title="Click to edit contract">${p.name}</div>
        ${salCells}
        ${actions}
      </div>
    `;
  }).join('');
  
  document.getElementById('rosterBody').innerHTML = html;
}

function renderDead() {
  const sec = document.getElementById('deadSection');
  if (!deadMoney.length) { 
    sec.style.display = 'none'; 
    return; 
  }
  sec.style.display = 'block';
  
  // Create table with years as columns
  const headerRow = YEARS.map(year => `<th>${year}</th>`).join('');
  
  const bodyRows = deadMoney.map(p => {
    const stretchLabel = p.stretched ? ' (STR)' : '';
    const cells = YEARS.map(year => {
      const sal = p.sal[year] || 0;
      return `<td>${fmt(sal)}</td>`;
    }).join('');
    
    return `<tr><td>${p.name}${stretchLabel}</td>${cells}</tr>`;
  }).join('');
  
  document.getElementById('deadMoneyTable').innerHTML = `
    <thead>
      <tr>
        <th>Player</th>
        ${headerRow}
      </tr>
    </thead>
    <tbody>
      ${bodyRows}
    </tbody>
  `;
}

function renderTrade() {
  const sec = document.getElementById('tradeSection');
  const hasOutgoing = tradeBlock.length > 0;
  const hasIncoming = incomingPlayers.length > 0;
  
  if (!hasOutgoing && !hasIncoming) {
    sec.style.display = 'none';
    return;
  }
  
  sec.style.display = 'block';
  
  if (acquisitionMode === 'trade' && hasIncoming) {
    document.getElementById('incomingSection').style.display = 'block';
    const incomingHtml = incomingPlayers.map(p => {
      const salCells = YEARS.map(year => {
        const sal = p.sal[year] || 0;
        return `<div class="sal-cell"><span class="s-amt">${fmt(sal)}</span></div>`;
      }).join('');
      
      return `
        <div class="tbl-row" style="background:rgba(16,185,129,.05)">
          <div class="r-num">ğŸ“¥</div>
          <div class="r-name">${p.name}</div>
          ${salCells}
          <div class="act">
            <button class="act-btn" onclick="removeIncoming(${p.id})">Remove</button>
          </div>
        </div>
      `;
    }).join('');
    
    const incomingTotals = YEARS.map(year => {
      const total = incomingPlayers.reduce((sum, p) => sum + (p.sal[year] || 0), 0);
      return `<div>${fmt(total)}</div>`;
    }).join('');
    
    document.getElementById('incomingBody').innerHTML = incomingHtml;
    document.getElementById('incomingTotal').innerHTML = `
      <div></div><div style="text-align:left; padding-left:0">Total Incoming:</div>
      ${incomingTotals}
      <div></div>
    `;
  } else {
    document.getElementById('incomingSection').style.display = 'none';
  }
  
  if (hasOutgoing) {
    const outgoingHtml = tradeBlock.map(p => {
      const salCells = YEARS.map(year => {
        const sal = p.sal[year] || 0;
        return `<div class="sal-cell"><span class="s-amt">${fmt(sal)}</span></div>`;
      }).join('');
      
      return `
        <div class="tbl-row" style="background:rgba(239,68,68,.05)">
          <div class="r-num">ğŸ“¤</div>
          <div class="r-name">${p.name}</div>
          ${salCells}
          <div class="act">
            <button class="act-btn" onclick="toggleTrade(${p.id})">Remove</button>
          </div>
        </div>
      `;
    }).join('');
    
    const outgoingTotals = YEARS.map(year => {
      const total = tradeBlock.reduce((sum, p) => sum + (p.sal[year] || 0), 0);
      return `<div>${fmt(total)}</div>`;
    }).join('');
    
    document.getElementById('tradeBody').innerHTML = outgoingHtml;
    document.getElementById('outgoingTotal').innerHTML = `
      <div></div><div style="text-align:left; padding-left:0">Total Outgoing:</div>
      ${outgoingTotals}
      <div></div>
    `;
  }
  
  if (acquisitionMode === 'trade' && hasOutgoing && hasIncoming) {
    const outgoing2025 = tradeBlock.reduce((sum, p) => sum + (p.sal['2025-26'] || 0), 0);
    const incoming2025 = incomingPlayers.reduce((sum, p) => sum + (p.sal['2025-26'] || 0), 0);
    
    const match = calculateTradeMatch(outgoing2025);
    const isLegal = incoming2025 <= match.max;
    
    document.getElementById('tradeLegalityBox').innerHTML = `
      <div class="trade-legality">
        <div class="trade-legality-title">âš–ï¸ TRADE LEGALITY CHECK (2025-26 Only)</div>
        <div class="trade-legality-row">
          <span class="lbl">Outgoing Salary:</span>
          <span class="val">${fmt(outgoing2025)}</span>
        </div>
        <div class="trade-legality-row">
          <span class="lbl">Rule Applied:</span>
          <span class="val">${match.formula} (${match.rule})</span>
        </div>
        <div class="trade-legality-row">
          <span class="lbl">Maximum Incoming:</span>
          <span class="val">${fmt(match.max)}</span>
        </div>
        <div class="trade-legality-row">
          <span class="lbl">Incoming Salary:</span>
          <span class="val">${fmt(incoming2025)}</span>
        </div>
        <div class="trade-legality-row">
          <span class="lbl">Trade Status:</span>
          <span class="trade-status ${isLegal ? 'legal' : 'illegal'}">
            ${isLegal ? 'âœ… LEGAL TRADE' : 'âŒ ILLEGAL TRADE'}
          </span>
        </div>
      </div>
    `;
  } else {
    document.getElementById('tradeLegalityBox').innerHTML = '';
  }
}

function renderCapSituation() {
  const rows = [
    { label: 'Cap Room', key: 'cap' },
    { label: 'Tax Room', key: 'tax' },
    { label: '1st Apron', key: 'apron1' },
    { label: '2nd Apron', key: 'apron2' }
  ];
  
  const html = rows.map(row => {
    const cells = YEARS.map(year => {
      const th = CAP_THRESHOLDS[year];
      const total = roster.reduce((sum, p) => sum + (p.sal[year] || 0), 0) +
                    deadMoney.reduce((sum, p) => sum + (p.sal[year] || 0), 0);
      const room = th[row.key] - total;
      const cls = room > 0 ? 'pos' : 'neg';
      return `<td class="${cls}">${fmt(Math.abs(room))}</td>`;
    }).join('');
    
    return `<tr><td>${row.label}</td>${cells}</tr>`;
  }).join('');
  
  document.getElementById('capSituationBody').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTION HANDLERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleTrade(id) {
  const idx = tradeBlock.findIndex(p => p.id === id);
  if (idx > -1) {
    tradeBlock.splice(idx, 1);
  } else {
    const player = roster.find(p => p.id === id);
    if (player) tradeBlock.push(player);
  }
  saveHistory();
  render();
}

function removeIncoming(id) {
  incomingPlayers = incomingPlayers.filter(p => p.id !== id);
  saveHistory();
  render();
}

function handleOption(id) {
  const player = roster.find(p => p.id === id);
  if (!player) return;
  
  let optYear = null;
  let optType = null;
  for (const year of YEARS) {
    const typ = player.typ[year];
    if (['po','to','qo','ch'].includes(typ)) {
      optYear = year;
      optType = typ;
      break;
    }
  }
  
  if (!optYear) {
    alert('No option found for this player');
    return;
  }
  
  const typeLabels = {
    'po': 'Player Option',
    'to': 'Team Option',
    'qo': 'Qualifying Offer',
    'ch': 'Cap Hold'
  };
  
  const label = typeLabels[optType] || 'Option';
  const amount = fmt(player.sal[optYear]);
  
  showModal(`
    <div class="modal-hdr">${player.name} - ${label}</div>
    <div class="modal-body">
      <div class="modal-row">
        <div class="modal-lbl">${label} for ${optYear}</div>
        <div style="font-size:24px; font-weight:700; color:var(--txt)">${amount}</div>
      </div>
      <div class="modal-row">
        <p style="color:var(--txt2); font-size:13px; line-height:1.6">
          ${optType === 'po' ? 'Player can choose to opt in or become a free agent.' : ''}
          ${optType === 'to' ? 'Team can choose to exercise the option or let player become a free agent.' : ''}
          ${optType === 'qo' ? 'Qualifying offer makes player a restricted free agent.' : ''}
          ${optType === 'ch' ? 'Cap hold against team salary if option not exercised.' : ''}
        </p>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn modal-btn-danger" onclick="declineOption(${id}, '${optYear}')">Decline</button>
        <button class="modal-btn modal-btn-primary" onclick="pickupOption(${id}, '${optYear}')">Pick Up</button>
      </div>
    </div>
  `);
}

function pickupOption(id, year) {
  const player = roster.find(p => p.id === id);
  if (player) {
    player.typ[year] = 'gtd';
    saveHistory();
    render();
  }
  closeModal();
}

function declineOption(id, year) {
  const player = roster.find(p => p.id === id);
  if (player) {
    const yearIdx = YEARS.indexOf(year);
    for (let i = yearIdx; i < YEARS.length; i++) {
      player.sal[YEARS[i]] = 0;
      player.typ[YEARS[i]] = '';
    }
    saveHistory();
    render();
  }
  closeModal();
}

function waiveCapHold(id) {
  const player = roster.find(p => p.id === id);
  if (!player) return;
  
  if (!confirm(`Waive cap hold for ${player.name}? Player will remain on roster for 2025-26 only.`)) return;
  
  let chYear = null;
  for (const year of YEARS.slice(1)) {
    if (player.typ[year] === 'ch') {
      chYear = year;
      break;
    }
  }
  
  if (!chYear) {
    alert('No cap hold found');
    return;
  }
  
  const chIdx = YEARS.indexOf(chYear);
  for (let i = chIdx; i < YEARS.length; i++) {
    player.sal[YEARS[i]] = 0;
    player.typ[YEARS[i]] = '';
  }
  
  saveHistory();
  render();
}

function handleWaive(id) {
  const player = roster.find(p => p.id === id);
  if (!player) return;
  
  const stretchableYears = YEARS.filter(year => {
    const typ = player.typ[year] || '';
    const sal = player.sal[year] || 0;
    return ['gtd', 'po', 'to'].includes(typ) && sal > 0;
  });
  
  if (stretchableYears.length === 0) {
    alert('No stretchable salary found');
    return;
  }
  
  const yearOptions = stretchableYears.map(y => 
    `<option value="${y}">${y}</option>`
  ).join('');
  
  showModal(`
    <div class="modal-hdr">Waive ${player.name}</div>
    <div class="modal-body">
      <div class="modal-row">
        <div class="modal-lbl">When to waive?</div>
        <select class="modal-select" id="waiveYear">
          ${yearOptions}
        </select>
      </div>
      <div class="modal-actions" style="flex-direction:column; gap:12px">
        <button class="modal-btn modal-btn-danger" onclick="waiveImmediate(${id})" style="width:100%">
          ğŸ’€ Waive Immediately
        </button>
        <button class="modal-btn modal-btn-primary" onclick="waiveStretch(${id})" style="width:100%">
          ğŸ“Š Waive with Stretch
        </button>
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()" style="width:100%">
          Cancel
        </button>
      </div>
    </div>
  `);
}

function waiveImmediate(id) {
  const player = roster.find(p => p.id === id);
  if (!player) return;
  
  const startYear = document.getElementById('waiveYear').value;
  const startIdx = YEARS.indexOf(startYear);
  
  const gtdAmounts = {};
  for (let i = startIdx; i < YEARS.length; i++) {
    const year = YEARS[i];
    if (player.typ[year] === 'gtd' && player.sal[year] > 0) {
      gtdAmounts[year] = player.sal[year];
    }
  }
  
  deadMoney.push({
    id: Date.now(),
    name: player.name,
    sal: gtdAmounts,
    typ: Object.keys(gtdAmounts).reduce((acc, y) => ({...acc, [y]: 'dead'}), {}),
    stretched: false,
    stretchStart: null
  });
  
  roster = roster.filter(p => p.id !== id);
  
  saveHistory();
  render();
  closeModal();
}

function waiveStretch(id) {
  const player = roster.find(p => p.id === id);
  if (!player) return;
  
  const startYear = document.getElementById('waiveYear').value;
  const stretch = calculateStretchProvision(player, startYear);
  
  if (!stretch) {
    alert('Cannot calculate stretch provision');
    closeModal();
    return;
  }
  
  const stretchedSal = {};
  const stretchedTyp = {};
  
  for (let i = 0; i < stretch.startIdx; i++) {
    const year = YEARS[i];
    if (player.sal[year] > 0) {
      stretchedSal[year] = player.sal[year];
      stretchedTyp[year] = 'dead';
    }
  }
  
  for (let i = 0; i < stretch.stretchYears && (stretch.startIdx + i) < YEARS.length; i++) {
    const year = YEARS[stretch.startIdx + i];
    stretchedSal[year] = stretch.annualHit;
    stretchedTyp[year] = 'dead';
  }
  
  deadMoney.push({
    id: Date.now(),
    name: player.name,
    sal: stretchedSal,
    typ: stretchedTyp,
    stretched: true,
    stretchStart: startYear
  });
  
  roster = roster.filter(p => p.id !== id);
  
  alert(`${player.name} stretched: ${fmt(stretch.totalGtd)} over ${stretch.stretchYears} years = ${fmt(stretch.annualHit)}/year starting ${startYear}`);
  
  saveHistory();
  render();
  closeModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH & ADD PLAYERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const searchInput = document.getElementById('searchInput');
const dropdown = document.getElementById('searchDropdown');

searchInput.addEventListener('input', e => {
  const query = e.target.value.trim().toLowerCase();
  if (query.length < 2) {
    dropdown.classList.remove('show');
    return;
  }
  
  const results = NBA_DB.filter(p => 
    p.name.toLowerCase().includes(query) ||
    p.team.toLowerCase().includes(query)
  ).slice(0, 8);
  
  if (results.length === 0) {
    dropdown.innerHTML = '<div class="dropdown-item"><div class="d-name">No players found</div></div>';
    dropdown.classList.add('show');
    return;
  }
  
  dropdown.innerHTML = results.map(p => {
    const sal = fmt(p.sal['2025-26']);
    return `
      <div class="dropdown-item" onclick="selectPlayer('${p.name}', '${p.team}', ${JSON.stringify(p.sal).replace(/"/g, '&quot;')})">
        <div class="d-name">${p.name}</div>
        <div class="d-meta">${p.team} Â· ${sal}</div>
      </div>
    `;
  }).join('');
  
  dropdown.classList.add('show');
});

function selectPlayer(name, team, sal) {
  dropdown.classList.remove('show');
  searchInput.value = '';
  
  if (acquisitionMode === 'trade') {
    incomingPlayers.push({
      id: Date.now(),
      name: name,
      team: team,
      sal: sal,
      typ: YEARS.reduce((acc, y) => ({...acc, [y]: 'gtd'}), {})
    });
    saveHistory();
    render();
  } else {
    const newId = Math.max(...roster.map(p => p.id), 0) + 1;
    const newPlayer = {
      id: newId,
      name: name,
      sal: sal,
      typ: YEARS.reduce((acc, y) => ({...acc, [y]: sal[y] > 0 ? 'gtd' : ''}), {})
    };
    
    roster.push(newPlayer);
    saveHistory();
    render();
    
    showSalaryModal(newId);
  }
}

function showSalaryModal(id) {
  const player = roster.find(p => p.id === id);
  if (!player) return;
  
  const inputs = YEARS.map(year => {
    const val = (player.sal[year] || 0) / 1000000;
    return `
      <div class="modal-row">
        <div class="modal-lbl">${year}</div>
        <div class="modal-input-group">
          <input type="number" step="0.1" class="modal-input" id="sal-${year}" value="${val}" />
          <span>M</span>
        </div>
      </div>
    `;
  }).join('');
  
  showModal(`
    <div class="modal-hdr">Enter Salary for ${player.name}</div>
    <div class="modal-body">
      ${inputs}
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="saveSalary(${id})">Save</button>
      </div>
    </div>
  `);
}

function editContract(id) {
  const player = roster.find(p => p.id === id);
  if (!player) return;
  
  const inputs = YEARS.map(year => {
    const val = (player.sal[year] || 0) / 1000000;
    const currentType = player.typ[year] || '';
    const typeLabel = currentType ? ` (${currentType.toUpperCase()})` : '';
    
    return `
      <div class="modal-row">
        <div class="modal-lbl">${year}${typeLabel}</div>
        <div class="modal-input-group">
          <input type="number" step="0.1" class="modal-input" id="sal-${year}" value="${val}" />
          <span>M</span>
        </div>
      </div>
    `;
  }).join('');
  
  showModal(`
    <div class="modal-hdr">Edit Contract - ${player.name}</div>
    <div class="modal-body">
      <div class="modal-row">
        <p style="color:var(--txt2); font-size:12px; line-height:1.5; margin-bottom:12px">
          Edit any year's salary to model re-signing scenarios. When you change a CH, QO, PO, or TO, it will become GTD.
        </p>
      </div>
      ${inputs}
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" onclick="saveContractEdit(${id})">Save Changes</button>
      </div>
    </div>
  `);
}

function saveContractEdit(id) {
  const player = roster.find(p => p.id === id);
  if (!player) return;
  
  YEARS.forEach(year => {
    const input = document.getElementById(`sal-${year}`);
    if (input) {
      const val = parseFloat(input.value) || 0;
      const newSal = Math.floor(val * 1000000);
      
      // If salary changed and was previously CH/QO/PO/TO, change to GTD
      if (newSal !== player.sal[year] && ['ch', 'qo', 'po', 'to'].includes(player.typ[year])) {
        player.typ[year] = newSal > 0 ? 'gtd' : '';
      } else if (newSal !== player.sal[year]) {
        // If changing any other salary, set type appropriately
        player.typ[year] = newSal > 0 ? 'gtd' : '';
      }
      
      player.sal[year] = newSal;
    }
  });
  
  saveHistory();
  render();
  closeModal();
}

function saveSalary(id) {
  const player = roster.find(p => p.id === id);
  if (!player) return;
  
  YEARS.forEach(year => {
    const input = document.getElementById(`sal-${year}`);
    if (input) {
      const val = parseFloat(input.value) || 0;
      player.sal[year] = Math.floor(val * 1000000);
      player.typ[year] = val > 0 ? 'gtd' : '';
    }
  });
  
  saveHistory();
  render();
  closeModal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showModal(html) {
  document.getElementById('modal').innerHTML = html;
  document.getElementById('modalOverlay').classList.add('show');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY & PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function saveHistory() {
  redoStack = [];
  
  if (historyIndex < history.length - 1) {
    history = history.slice(0, historyIndex + 1);
  }
  
  history.push({
    roster: JSON.parse(JSON.stringify(roster)),
    capHolds: JSON.parse(JSON.stringify(capHolds)),
    deadMoney: JSON.parse(JSON.stringify(deadMoney)),
    emptyRows: JSON.parse(JSON.stringify(emptyRows)),
    tradeBlock: JSON.parse(JSON.stringify(tradeBlock)),
    incomingPlayers: JSON.parse(JSON.stringify(incomingPlayers))
  });
  
  if (history.length > MAX_HISTORY) history.shift();
  historyIndex = history.length - 1;
  
  saveState();
}

function undo() {
  if (historyIndex <= 0) {
    alert('Nothing to undo');
    return;
  }
  
  redoStack.push({
    roster: JSON.parse(JSON.stringify(roster)),
    capHolds: JSON.parse(JSON.stringify(capHolds)),
    deadMoney: JSON.parse(JSON.stringify(deadMoney)),
    emptyRows: JSON.parse(JSON.stringify(emptyRows)),
    tradeBlock: JSON.parse(JSON.stringify(tradeBlock)),
    incomingPlayers: JSON.parse(JSON.stringify(incomingPlayers))
  });
  
  historyIndex--;
  const state = history[historyIndex];
  roster = JSON.parse(JSON.stringify(state.roster));
  capHolds = JSON.parse(JSON.stringify(state.capHolds));
  deadMoney = JSON.parse(JSON.stringify(state.deadMoney));
  emptyRows = JSON.parse(JSON.stringify(state.emptyRows));
  tradeBlock = JSON.parse(JSON.stringify(state.tradeBlock));
  incomingPlayers = JSON.parse(JSON.stringify(state.incomingPlayers));
  
  render();
  saveState();
}

function redo() {
  if (redoStack.length === 0) {
    alert('Nothing to redo');
    return;
  }
  
  const state = redoStack.pop();
  historyIndex++;
  
  if (historyIndex >= history.length) {
    history.push(state);
  } else {
    history[historyIndex] = state;
  }
  
  roster = JSON.parse(JSON.stringify(state.roster));
  capHolds = JSON.parse(JSON.stringify(state.capHolds));
  deadMoney = JSON.parse(JSON.stringify(state.deadMoney));
  emptyRows = JSON.parse(JSON.stringify(state.emptyRows));
  tradeBlock = JSON.parse(JSON.stringify(state.tradeBlock));
  incomingPlayers = JSON.parse(JSON.stringify(state.incomingPlayers));
  
  render();
  saveState();
}

function saveState() {
  localStorage.setItem('bullsCapManager_v5.1', JSON.stringify({
    roster, capHolds, deadMoney, emptyRows, tradeBlock, incomingPlayers
  }));
}

function loadState() {
  const saved = localStorage.getItem('bullsCapManager_v5.1');
  if (saved) {
    try {
      const state = JSON.parse(saved);
      roster = state.roster || roster;
      capHolds = state.capHolds || [];
      deadMoney = state.deadMoney || deadMoney;
      emptyRows = state.emptyRows || [];
      tradeBlock = state.tradeBlock || [];
      incomingPlayers = state.incomingPlayers || [];
    } catch (e) {
      console.error('Failed to load state:', e);
    }
  }
}

function resetAll() {
  if (!confirm('Reset to original Bulls roster? This cannot be undone.')) return;
  localStorage.removeItem('bullsCapManager_v5.1');
  location.reload();
}

function addRow() {
  const newId = Math.max(...roster.map(p => p.id), ...emptyRows.map(p => p.id), 0) + 1;
  const newRow = {
    id: newId,
    name: 'New Player',
    sal: YEARS.reduce((acc, y) => ({...acc, [y]: 0}), {}),
    typ: YEARS.reduce((acc, y) => ({...acc, [y]: ''}), {})
  };
  roster.push(newRow);
  saveHistory();
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

loadState();
saveHistory();
render();
setAcquisitionMode('trade');

document.addEventListener('click', e => {
  if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
    dropdown.classList.remove('show');
  }
});

document.getElementById('modalOverlay').addEventListener('click', e => {
  if (e.target.id === 'modalOverlay') closeModal();
});

</script>
</body>
</html>
